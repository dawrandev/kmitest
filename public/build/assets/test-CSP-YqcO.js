document.addEventListener("DOMContentLoaded",function(){const u=window.questions||[],l=window.testData||{},I={timeUpTitle:"Time is up!",timeUpText:"Test is being completed automatically...",warningTitle:"Warning!",selectAnswer:"Please select an answer!",errorTitle:"Error!",errorOccurred:"An error occurred",serverError:"Could not connect to server",noFinishRoute:"Error: Test completion route not found. Please reload the page.",correctAnswer:"Correct answer!",wrongAnswer:"Wrong answer",finishTitle:"Finish Test",finishText:"Do you want to finish the test?",yesFinish:"Yes, finish",cancel:"Cancel",testFinished:"Test finished!",answeredQuestions:"Answered questions",correctAnswers:"Correct answers",wrongAnswers:"Wrong answers",timeUsed:"Time used"},T=window.translations||I;function s(e){return window.translations&&typeof window.translations[e]<"u"?window.translations[e]:T&&typeof T[e]<"u"?T[e]:I[e]||e}u.length>0&&u[0].id;let f=0,m={},p=0,$=new Set,h=typeof l.timeLimit<"u"&&!isNaN(Number(l.timeLimit))&&Number(l.timeLimit)>0?Number(l.timeLimit):15*60,d=h,v,g=!0,c=!1;function x(){const e=document.getElementById("timerDisplay"),t=document.getElementById("progressCircle");if(!e)return;let n=0;t&&(typeof t.getTotalLength=="function"?n=t.getTotalLength():n=2*Math.PI*35,t.style.strokeDasharray=`${n} ${n}   `,t.style.strokeDashoffset=0,t.style.transition="stroke-dashoffset 1s linear"),e.textContent=A(d),v=setInterval(function(){if(!(!g||c)){if(d--,e.textContent=A(d),t&&n>0){const o=(h-d)/h,i=n*o;t.style.strokeDashoffset=i,d<=300?(t.style.stroke="#ef4444",e.style.color="#ef4444"):d<=600&&(t.style.stroke="#f59e0b",e.style.color="#f59e0b")}d<=0&&(clearInterval(v),L())}},1e3)}function A(e){const t=Math.floor(e/60);let n=e%60;return n<10&&(n="0"+n),`${t}:${n}`}function L(){c||(g=!1,c=!0,document.querySelectorAll(".variant-card").forEach(e=>{e.style.pointerEvents="none",e.classList.add("disabled")}),document.querySelectorAll(".submit-btn").forEach(e=>e.disabled=!0),Swal.fire({title:s("timeUpTitle"),text:s("timeUpText"),icon:"warning",timer:2e3,timerProgressBar:!0,showConfirmButton:!1,allowOutsideClick:!1}).then(()=>E(!0)))}function b(){console.log("setupNavigationButtons ishga tushdi");const e=document.querySelectorAll(".nav-btn");console.log("Topilgan tugmalar soni:",e.length),e.forEach(function(t,n){console.log(`Tugma ${n+1}:`,t),t.onclick=function(o){if(o.preventDefault(),console.log("TUGMA BOSILDI!",this),c)return;const i=parseInt(this.dataset.questionId);console.log("Question ID:",i),document.querySelectorAll(".nav-btn").forEach(a=>{a.classList.remove("current")}),this.classList.add("current");const r=u.findIndex(a=>a.id===i);console.log("Question index:",r),r!==-1&&(f=r,B(i,r+1))},console.log(`Tugma ${n+1} ga event qo'shildi`)}),console.log("setupNavigationButtons tugadi")}document.querySelectorAll(".variant-card").forEach(function(e){e.addEventListener("click",function(t){if(!g||c)return;t.preventDefault(),t.stopPropagation();const n=parseInt(this.dataset.answerId,10),o=parseInt(this.dataset.questionId,10),i=document.getElementById(`question-${o}`);if(!i)return;i.querySelectorAll(".variant-card").forEach(S=>S.classList.remove("selected")),this.classList.add("selected");const a=i.querySelector(`input[value="${n}"]`);a&&(i.querySelectorAll('input[type="radio"]').forEach(S=>S.checked=!1),a.checked=!0),m[o]=n;const w=document.getElementById(`submitBtn${o}`);w&&(w.disabled=!1),this.style.animation="pulse 0.6s ease-in-out"})}),document.querySelectorAll(".submit-btn").forEach(function(e){e.addEventListener("click",function(t){if(!g||c)return;t.preventDefault();const n=parseInt(this.dataset.questionId,10),o=m[n];if(!o){Swal.fire({title:s("warningTitle"),text:s("selectAnswer"),icon:"warning",confirmButtonText:"OK"});return}l.routes&&l.routes.submitAnswer?O(n,o,this):C(n,o,this)})});function O(e,t,n){fetch(l.routes.submitAnswer,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":l.csrfToken},body:JSON.stringify({session_id:l.sessionId,question_id:e,answer_id:t})}).then(o=>o.json()).then(o=>{o.success?q(e,o.is_correct,n):Swal.fire({title:s("errorTitle"),text:o.message||s("errorOccurred"),icon:"error",confirmButtonText:"OK"})}).catch(()=>C(e,t,n))}function C(e,t,n){const o=document.getElementById(`question-${e}`),i=o?o.querySelector(`[data-answer-id="${t}"]`):null,r=i&&i.dataset.isCorrect==="true";q(e,r,n)}function q(e,t,n){if(c)return;$.add(e);const o=document.getElementById(`navBtn${e}`);o&&(o.classList.remove("current"),t?(o.classList.remove("incorrect"),o.classList.add("correct")):(o.classList.remove("correct"),o.classList.add("incorrect")),o.dataset.completed||(p++,o.dataset.completed="true",Q()));const i=document.getElementById(`question-${e}`);i&&i.querySelectorAll(".variant-card").forEach(r=>{r.style.pointerEvents="none",r.classList.add("disabled")}),n&&(n.disabled=!0,n.innerHTML=t?`<i class="icofont icofont-check me-2"></i>${s("correctAnswer")}`:`<i class="icofont icofont-close me-2"></i>${s("wrongAnswer")}`)}function Q(){const e=document.getElementById("completedCount"),t=document.getElementById("progressBar");if(e&&(e.textContent=p),t){const n=u.length>0?p/u.length*100:0;t.style.width=n+"%",t.setAttribute("aria-valuenow",p)}}function k(){const e=document.querySelector(".btn-danger, #finishTestBtn");return e&&e.addEventListener("click",D),e}function D(e){e&&(e.preventDefault(),e.stopPropagation()),Swal.fire({title:s("finishTitle"),text:s("finishText"),icon:"question",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#6c757d",confirmButtonText:s("yesFinish"),cancelButtonText:s("cancel")}).then(t=>{t.isConfirmed&&E(!1)})}function B(e,t){if(console.log(`showQuestion: ID=${e}, Number=${t}`),c)return;const n=document.querySelectorAll(".question-container");console.log("Barcha savollar soni:",n.length),n.forEach(a=>a.classList.remove("active"));const o=document.getElementById(`question-${e}`);console.log("Target question:",o),o?(o.classList.add("active"),console.log(`Question ${e} active qilindi`)):console.error(`Question ${e} topilmadi!`);const i=u.findIndex(a=>a.id===e);i!==-1&&(f=i);const r=document.getElementById("currentQuestion");r&&(r.textContent=t,console.log(`Question number ${t} ga o'zgartirildi`))}function F(){const e=document.getElementById("prevQuestionBtn"),t=document.getElementById("nextQuestionBtn");e&&(e.disabled=f===0||c,e.style.display=f===0?"none":"inline-block"),t&&(t.disabled=f===u.length-1||c,t.style.display=f===u.length-1?"none":"inline-block")}function E(e=!1){if(!(c&&!e)){if(!e&&!c&&(c=!0),clearInterval(v),g=!1,document.querySelectorAll(".nav-btn").forEach(t=>{t.disabled=!0,t.style.pointerEvents="none"}),!l||!l.routes||!l.routes.finish){Swal.fire({title:s("errorTitle"),text:s("noFinishRoute"),icon:"error",confirmButtonText:"OK"}).then(()=>y());return}fetch(l.routes.finish,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":l.csrfToken||"",Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({})}).then(t=>t.json()).then(t=>{t.success?t.redirect_url?window.location.href=t.redirect_url:y():Swal.fire({title:s("errorTitle"),text:t.message||s("errorOccurred"),icon:"error",confirmButtonText:"OK"}).then(()=>y())}).catch(()=>{Swal.fire({title:s("errorTitle"),text:s("serverError"),icon:"error",confirmButtonText:"OK"}).then(()=>y())})}}function y(){let e=Object.keys(m||{}).length,t=0,n=0;for(let r in m||{}){const a=m[r],w=document.querySelector(`[data-question-id="${r}"][data-answer-id="${a}"]`);w&&w.dataset.isCorrect==="true"?t++:n++}const o=Math.floor((h-d)/60),i=(h-d)%60;Swal.fire({title:s("testFinished"),html:`
                <div class="text-start">
                    <p><strong>${s("answeredQuestions")}:</strong> ${e}</p>
                    <p><strong>${s("correctAnswers")}:</strong> ${t}</p>
                    <p><strong>${s("wrongAnswers")}:</strong> ${n}</p>
                    <p><strong>${s("timeUsed")}:</strong> ${o}:${i.toString().padStart(2,"0")}</p>
                </div>
            `,icon:"info",confirmButtonText:"OK",allowOutsideClick:!1}).then(()=>{window.location.href="/student/"})}window.showQuestion=B,window.finishTest=E,x(),u.length>0&&B(u[0].id,1),setTimeout(()=>{k(),b(),F()},500)});
