document.addEventListener("DOMContentLoaded",function(){const l=window.questions||[],u=window.testData||{},S={timeUpTitle:"Time is up!",timeUpText:"Test is being completed automatically...",warningTitle:"Warning!",selectAnswer:"Please select an answer!",errorTitle:"Error!",errorOccurred:"An error occurred",serverError:"Could not connect to server",noFinishRoute:"Error: Test completion route not found. Please reload the page.",correctAnswer:"Correct answer!",wrongAnswer:"Wrong answer",finishTitle:"Finish Test",finishText:"Do you want to finish the test?",yesFinish:"Yes, finish",cancel:"Cancel",testFinished:"Test finished!",answeredQuestions:"Answered questions",correctAnswers:"Correct answers",wrongAnswers:"Wrong answers",timeUsed:"Time used"},I=window.translations||S;function i(e){return window.translations&&typeof window.translations[e]<"u"?window.translations[e]:I&&typeof I[e]<"u"?I[e]:S[e]||e}l.length>0&&l[0].id;let c=0,h={},y=0,x=new Set,v=typeof u.timeLimit<"u"&&!isNaN(Number(u.timeLimit))&&Number(u.timeLimit)>0?Number(u.timeLimit):15*60,d=v,T,w=!0,a=!1;function b(){const e=document.getElementById("timerDisplay"),t=document.getElementById("progressCircle");if(!e)return;let n=0;t&&(typeof t.getTotalLength=="function"?n=t.getTotalLength():n=2*Math.PI*35,t.style.strokeDasharray=`${n} ${n}   `,t.style.strokeDashoffset=0,t.style.transition="stroke-dashoffset 1s linear"),e.textContent=C(d),T=setInterval(function(){if(!(!w||a)){if(d--,e.textContent=C(d),t&&n>0){const s=(v-d)/v,r=n*s;t.style.strokeDashoffset=r,d<=300?(t.style.stroke="#ef4444",e.style.color="#ef4444"):d<=600&&(t.style.stroke="#f59e0b",e.style.color="#f59e0b")}d<=0&&(clearInterval(T),$())}},1e3)}function C(e){const t=Math.floor(e/60);let n=e%60;return n<10&&(n="0"+n),`${t}:${n}`}function $(){a||(w=!1,a=!0,document.querySelectorAll(".variant-card").forEach(e=>{e.style.pointerEvents="none",e.classList.add("disabled")}),document.querySelectorAll(".submit-btn").forEach(e=>e.disabled=!0),Swal.fire({title:i("timeUpTitle"),text:i("timeUpText"),icon:"warning",timer:2e3,timerProgressBar:!0,showConfirmButton:!1,allowOutsideClick:!1}).then(()=>B(!0)))}function k(){const e=document.getElementById("prevQuestionBtn");e&&e.addEventListener("click",function(){if(c>0&&!a){c--;const n=l[c].id;p(n,c+1)}});const t=document.getElementById("nextQuestionBtn");t&&t.addEventListener("click",function(){if(c<l.length-1&&!a){c++;const n=l[c].id;p(n,c+1)}}),document.querySelectorAll(".nav-btn").forEach(function(n){n.addEventListener("click",function(){if(a)return;const s=parseInt(this.dataset.questionId,10),r=l.findIndex(o=>o.id===s);r!==-1&&(c=r,p(s,r+1))})})}document.querySelectorAll(".variant-card").forEach(function(e){e.addEventListener("click",function(t){if(!w||a)return;t.preventDefault(),t.stopPropagation();const n=parseInt(this.dataset.answerId,10),s=parseInt(this.dataset.questionId,10),r=document.getElementById(`question-${s}`);if(!r)return;r.querySelectorAll(".variant-card").forEach(g=>g.classList.remove("selected")),this.classList.add("selected");const f=r.querySelector(`input[value="${n}"]`);f&&(r.querySelectorAll('input[type="radio"]').forEach(g=>g.checked=!1),f.checked=!0),h[s]=n;const m=document.getElementById(`submitBtn${s}`);m&&(m.disabled=!1),this.style.animation="pulse 0.6s ease-in-out"})}),document.querySelectorAll(".submit-btn").forEach(function(e){e.addEventListener("click",function(t){if(!w||a)return;t.preventDefault();const n=parseInt(this.dataset.questionId,10),s=h[n];if(!s){Swal.fire({title:i("warningTitle"),text:i("selectAnswer"),icon:"warning",confirmButtonText:"OK"});return}u.routes&&u.routes.submitAnswer?O(n,s,this):q(n,s,this)})});function O(e,t,n){fetch(u.routes.submitAnswer,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":u.csrfToken},body:JSON.stringify({session_id:u.sessionId,question_id:e,answer_id:t})}).then(s=>s.json()).then(s=>{s.success?A(e,s.is_correct,n):Swal.fire({title:i("errorTitle"),text:s.message||i("errorOccurred"),icon:"error",confirmButtonText:"OK"})}).catch(()=>q(e,t,n))}function q(e,t,n){const s=document.getElementById(`question-${e}`),r=s?s.querySelector(`[data-answer-id="${t}"]`):null,o=r&&r.dataset.isCorrect==="true";A(e,o,n)}function A(e,t,n){if(a)return;x.add(e);const s=document.getElementById(`navBtn${e}`);s&&(s.classList.remove("current"),t?(s.classList.remove("incorrect"),s.classList.add("correct")):(s.classList.remove("correct"),s.classList.add("incorrect")),s.dataset.completed||(y++,s.dataset.completed="true",Q()));const r=document.getElementById(`question-${e}`);r&&r.querySelectorAll(".variant-card").forEach(o=>{o.style.pointerEvents="none",o.classList.add("disabled")}),n&&(n.disabled=!0,n.innerHTML=t?`<i class="icofont icofont-check me-2"></i>${i("correctAnswer")}`:`<i class="icofont icofont-close me-2"></i>${i("wrongAnswer")}`),setTimeout(()=>{if(y>=l.length)clearInterval(T),w=!1,B();else if(c<l.length-1){c++;const o=l[c].id;p(o,c+1)}},1500)}function Q(){const e=document.getElementById("completedCount"),t=document.getElementById("progressBar");if(e&&(e.textContent=y),t){const n=l.length>0?y/l.length*100:0;t.style.width=n+"%",t.setAttribute("aria-valuenow",y)}}function D(){const e=document.querySelector(".btn-danger, #finishTestBtn");return e&&e.addEventListener("click",F),e}function F(e){e&&(e.preventDefault(),e.stopPropagation()),Swal.fire({title:i("finishTitle"),text:i("finishText"),icon:"question",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#6c757d",confirmButtonText:i("yesFinish"),cancelButtonText:i("cancel")}).then(t=>{t.isConfirmed&&B(!1)})}function p(e,t){if(a)return;document.querySelectorAll(".question-container").forEach(o=>o.classList.remove("active"));const n=document.getElementById(`question-${e}`);n&&n.classList.add("active"),document.querySelectorAll(".nav-btn").forEach(o=>o.classList.remove("current"));const s=document.getElementById(`navBtn${e}`);s&&!s.classList.contains("correct")&&!s.classList.contains("incorrect")&&s.classList.add("current");const r=document.getElementById("currentQuestion");if(r&&(r.textContent=t),L(),h[e]){const o=h[e],f=document.getElementById(`question-${e}`);if(f){const m=f.querySelector(`[data-answer-id="${o}"]`);if(m){m.classList.add("selected");const g=f.querySelector(`input[value="${o}"]`);g&&(g.checked=!0)}}}}function L(){const e=document.getElementById("prevQuestionBtn"),t=document.getElementById("nextQuestionBtn");e&&(e.disabled=c===0||a,e.style.display=c===0?"none":"inline-block"),t&&(t.disabled=c===l.length-1||a,t.style.display=c===l.length-1?"none":"inline-block")}function B(e=!1){if(!(a&&!e)){if(!e&&!a&&(a=!0),clearInterval(T),w=!1,document.querySelectorAll(".nav-btn").forEach(t=>{t.disabled=!0,t.style.pointerEvents="none"}),!u||!u.routes||!u.routes.finish){Swal.fire({title:i("errorTitle"),text:i("noFinishRoute"),icon:"error",confirmButtonText:"OK"}).then(()=>E());return}fetch(u.routes.finish,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":u.csrfToken||"",Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({})}).then(t=>t.json()).then(t=>{t.success?t.redirect_url?window.location.href=t.redirect_url:E():Swal.fire({title:i("errorTitle"),text:t.message||i("errorOccurred"),icon:"error",confirmButtonText:"OK"}).then(()=>E())}).catch(()=>{Swal.fire({title:i("errorTitle"),text:i("serverError"),icon:"error",confirmButtonText:"OK"}).then(()=>E())})}}function E(){let e=Object.keys(h||{}).length,t=0,n=0;for(let o in h||{}){const f=h[o],m=document.querySelector(`[data-question-id="${o}"][data-answer-id="${f}"]`);m&&m.dataset.isCorrect==="true"?t++:n++}const s=Math.floor((v-d)/60),r=(v-d)%60;Swal.fire({title:i("testFinished"),html:`
                <div class="text-start">
                    <p><strong>${i("answeredQuestions")}:</strong> ${e}</p>
                    <p><strong>${i("correctAnswers")}:</strong> ${t}</p>
                    <p><strong>${i("wrongAnswers")}:</strong> ${n}</p>
                    <p><strong>${i("timeUsed")}:</strong> ${s}:${r.toString().padStart(2,"0")}</p>
                </div>
            `,icon:"info",confirmButtonText:"OK",allowOutsideClick:!1}).then(()=>{window.location.href="/student/"})}window.showQuestion=p,window.finishTest=B,b(),l.length>0&&p(l[0].id,1),setTimeout(()=>{D(),k(),L()},500)});
