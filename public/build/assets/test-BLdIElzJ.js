document.addEventListener("DOMContentLoaded",function(){const f=window.questions||[],c=window.testData||{},A={timeUpTitle:"Time is up!",timeUpText:"Test is being completed automatically...",warningTitle:"Warning!",selectAnswer:"Please select an answer!",errorTitle:"Error!",errorOccurred:"An error occurred",serverError:"Could not connect to server",noFinishRoute:"Error: Test completion route not found. Please reload the page.",correctAnswer:"Correct answer!",wrongAnswer:"Wrong answer",finishTitle:"Finish Test",finishText:"Do you want to finish the test?",yesFinish:"Yes, finish",cancel:"Cancel",testFinished:"Test finished!",answeredQuestions:"Answered questions",correctAnswers:"Correct answers",wrongAnswers:"Wrong answers",timeUsed:"Time used"},E=window.translations||A;function r(e){return window.translations&&typeof window.translations[e]<"u"?window.translations[e]:E&&typeof E[e]<"u"?E[e]:A[e]||e}f.length>0&&f[0].id;let h={},w=0,p=typeof c.timeLimit<"u"&&!isNaN(Number(c.timeLimit))&&Number(c.timeLimit)>0?Number(c.timeLimit):25*60,a=p,y,m=!0,l=!1;function q(){const e=document.getElementById("timerDisplay"),t=document.getElementById("progressCircle");if(!e)return;let n=0;t&&(typeof t.getTotalLength=="function"?n=t.getTotalLength():n=2*Math.PI*35,t.style.strokeDasharray=`${n} ${n}`,t.style.strokeDashoffset=0,t.style.transition="stroke-dashoffset 1s linear"),e.textContent=C(a),y=setInterval(function(){if(!(!m||l)){if(a--,e.textContent=C(a),t&&n>0){const s=(p-a)/p,o=n*s;t.style.strokeDashoffset=o,a<=300?(t.style.stroke="#ef4444",e.style.color="#ef4444"):a<=600&&(t.style.stroke="#f59e0b",e.style.color="#f59e0b")}a<=0&&(clearInterval(y),L())}},1e3)}function C(e){const t=Math.floor(e/60);let n=e%60;return n<10&&(n="0"+n),`${t}:${n}`}function L(){l||(m=!1,l=!0,document.querySelectorAll(".variant-card").forEach(e=>{e.style.pointerEvents="none",e.classList.add("disabled")}),document.querySelectorAll(".submit-btn").forEach(e=>e.disabled=!0),Swal.fire({title:r("timeUpTitle"),text:r("timeUpText"),icon:"warning",timer:2e3,timerProgressBar:!0,showConfirmButton:!1,allowOutsideClick:!1}).then(()=>T(!0)))}document.querySelectorAll(".variant-card").forEach(function(e){e.addEventListener("click",function(t){if(!m||l)return;t.preventDefault(),t.stopPropagation();const n=parseInt(this.dataset.answerId,10),s=parseInt(this.dataset.questionId,10),o=document.getElementById(`question-${s}`);if(!o)return;o.querySelectorAll(".variant-card").forEach(g=>g.classList.remove("selected")),this.classList.add("selected");const d=o.querySelector(`input[value="${n}"]`);d&&(o.querySelectorAll('input[type="radio"]').forEach(g=>g.checked=!1),d.checked=!0),h[s]=n;const u=document.getElementById(`submitBtn${s}`);u&&(u.disabled=!1),this.style.animation="pulse 0.6s ease-in-out"})}),document.querySelectorAll(".submit-btn").forEach(function(e){e.addEventListener("click",function(t){if(!m||l)return;t.preventDefault();const n=parseInt(this.dataset.questionId,10),s=h[n];if(!s){Swal.fire({title:r("warningTitle"),text:r("selectAnswer"),icon:"warning",confirmButtonText:"OK"});return}c.routes&&c.routes.submitAnswer?x(n,s,this):I(n,s,this)})});function x(e,t,n){fetch(c.routes.submitAnswer,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":c.csrfToken},body:JSON.stringify({session_id:c.sessionId,question_id:e,answer_id:t})}).then(s=>s.json()).then(s=>{s.success?S(e,s.is_correct,n):Swal.fire({title:r("errorTitle"),text:s.message||r("errorOccurred"),icon:"error",confirmButtonText:"OK"})}).catch(()=>I(e,t,n))}function I(e,t,n){const s=document.getElementById(`question-${e}`),o=s?s.querySelector(`[data-answer-id="${t}"]`):null,i=o&&o.dataset.isCorrect==="true";S(e,i,n)}function S(e,t,n){if(l)return;const s=document.getElementById(`navBtn${e}`);s&&(s.classList.remove("current"),t?(s.classList.remove("incorrect"),s.classList.add("correct")):(s.classList.remove("correct"),s.classList.add("incorrect")),s.dataset.completed||(w++,s.dataset.completed="true",$()));const o=document.getElementById(`question-${e}`);o&&o.querySelectorAll(".variant-card").forEach(i=>{i.style.pointerEvents="none",i.classList.add("disabled")}),n&&(n.disabled=!0,n.innerHTML=t?`<i class="icofont icofont-check me-2"></i>${r("correctAnswer")}`:`<i class="icofont icofont-close me-2"></i>${r("wrongAnswer")}`),setTimeout(()=>{const i=Array.from(document.querySelectorAll(".question-container")),d=i.findIndex(u=>u.classList.contains("active"));if(w>=i.length)clearInterval(y),m=!1,T();else if(d<i.length-1){const u=i[d+1],g=parseInt(u.id.replace("question-",""),10);B(g,d+2)}},1500)}function $(){const e=document.getElementById("completedCount"),t=document.getElementById("progressBar");if(e&&(e.textContent=w),t){const n=f.length>0?w/f.length*100:0;t.style.width=n+"%",t.setAttribute("aria-valuenow",w)}}function b(){const e=document.getElementById("finishTestBtn");return e&&e.addEventListener("click",O),e}function O(e){e&&(e.preventDefault(),e.stopPropagation()),Swal.fire({title:r("finishTitle"),text:r("finishText"),icon:"question",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#6c757d",confirmButtonText:r("yesFinish"),cancelButtonText:r("cancel")}).then(t=>{t.isConfirmed&&T(!1)})}function B(e,t){if(l)return;document.querySelectorAll(".question-container").forEach(i=>i.classList.remove("active"));const n=document.getElementById(`question-${e}`);n&&n.classList.add("active"),document.querySelectorAll(".nav-btn").forEach(i=>i.classList.remove("current"));const s=document.getElementById(`navBtn${e}`);s&&!s.classList.contains("correct")&&!s.classList.contains("incorrect")&&s.classList.add("current");const o=document.getElementById("currentQuestion");o&&(o.textContent=t)}function T(e=!1){if(!(l&&!e)){if(!e&&!l&&(l=!0),clearInterval(y),m=!1,!c||!c.routes||!c.routes.finish){Swal.fire({title:r("errorTitle"),text:r("noFinishRoute"),icon:"error",confirmButtonText:"OK"}).then(()=>v());return}fetch(c.routes.finish,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":c.csrfToken||"",Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({})}).then(t=>t.json()).then(t=>{t.success?t.redirect_url?window.location.href=t.redirect_url:v():Swal.fire({title:r("errorTitle"),text:t.message||r("errorOccurred"),icon:"error",confirmButtonText:"OK"}).then(()=>v())}).catch(()=>{Swal.fire({title:r("errorTitle"),text:r("serverError"),icon:"error",confirmButtonText:"OK"}).then(()=>v())})}}function v(){let e=Object.keys(h||{}).length,t=0,n=0;for(let i in h||{}){const d=h[i],u=document.querySelector(`[data-question-id="${i}"][data-answer-id="${d}"]`);u&&u.dataset.isCorrect==="true"?t++:n++}const s=Math.floor((p-a)/60),o=(p-a)%60;Swal.fire({title:r("testFinished"),html:`
                <div class="text-start">
                    <p><strong>${r("answeredQuestions")}:</strong> ${e}</p>
                    <p><strong>${r("correctAnswers")}:</strong> ${t}</p>
                    <p><strong>${r("wrongAnswers")}:</strong> ${n}</p>
                    <p><strong>${r("timeUsed")}:</strong> ${s}:${o.toString().padStart(2,"0")}</p>
                </div>
            `,icon:"info",confirmButtonText:"OK",allowOutsideClick:!1}).then(()=>{window.location.href="/student/"})}window.showQuestion=B,window.finishTest=T,q(),f.length>0&&B(f[0].id,1),setTimeout(()=>{b()},500)});
